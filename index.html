<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <!-- 
        MOSS çºªå¿µæ¡£æ¡ˆé¦† - ä¸»é¡µé¢
        é¡¹ç›®ä»£å·ï¼šMOSS çºªå¿µæ¡£æ¡ˆé¦†ï¼šäººç±»æ–‡æ˜æ•°å­—é—äº§
        
        æ ¸å¿ƒæ¦‚å¿µï¼š"ä»¥æœ€ç†æ€§çš„äº¤äº’ï¼Œæ¢å¯»æœ€æ„Ÿæ€§çš„è®°å¿†"
        
        æŠ€æœ¯æ¶æ„ï¼š
        - HTML5 è¯­ä¹‰åŒ–ç»“æ„
        - CSS3 æ¨¡å—åŒ–æ ·å¼
        - åŸç”Ÿ JavaScript ES6+ æ¨¡å—åŒ–å¼€å‘
        - æ— å¤–éƒ¨æ¡†æ¶ä¾èµ–ï¼ˆé™¤å­—ä½“ï¼‰
    -->
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="MOSS çºªå¿µæ¡£æ¡ˆé¦†ï¼šæ¢ç´¢äººç±»æ–‡æ˜æ•°å­—é—äº§çš„äº¤äº’å¼ä½“éªŒ">
    <meta name="keywords" content="MOSS,æµæµªåœ°çƒ,ç§‘å¹»,äº¤äº’,æ¡£æ¡ˆé¦†,äººç±»æ–‡æ˜">
    <meta name="author" content="MOSS Archive Team">
    
    <title>MOSS çºªå¿µæ¡£æ¡ˆé¦† - äººç±»æ–‡æ˜æ•°å­—é—äº§</title>
    
    <!-- å¼•å…¥æ¨¡å—åŒ–æ ·å¼æ–‡ä»¶ -->
    <link rel="stylesheet" href="css/styles.css">
    
    <!-- é¢„åŠ è½½å…³é”®èµ„æº -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
</head>
<body>
    <!-- CRT è€å¼æ˜¾ç¤ºå™¨æ•ˆæœå åŠ å±‚ -->
    <div class="crt-overlay" aria-hidden="true"></div>
    
    <!-- æ¨¡å—ä¸€ï¼šMOSS è®¤è¯åè®®ç•Œé¢ -->
    <div class="login-container" id="loginContainer">
        <div class="command-prompt" role="banner">ç­‰å¾…æŒ‡ä»¤è¾“å…¥...</div>
        <div class="cursor" aria-hidden="true">â–ˆ</div>
        <div class="input-display" id="inputDisplay" role="textbox" aria-label="å‘½ä»¤è¾“å…¥æ˜¾ç¤º"></div>
    </div>

    <!-- æ¨¡å—äºŒï¼šèˆªç¨‹å¼•å¯¼ 3D åœºæ™¯å®¹å™¨ -->
    <div class="voyage-container" id="voyageContainer" style="display: none;">
        <!-- Three.js 3D åœºæ™¯å°†åœ¨è¿™é‡Œæ¸²æŸ“ -->
    </div>

    <!-- 
        JavaScript æ¨¡å—åŠ è½½
        é‡‡ç”¨æ¨¡å—åŒ–æ¶æ„ï¼Œä¾¿äºç»´æŠ¤å’Œæ‰©å±•
    -->
    
    <!-- Three.js 3Då›¾å½¢åº“ -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/controls/OrbitControls.js"></script>
    
    <!-- è®¤è¯æ¨¡å— - å¤„ç†ç™»å½•éªŒè¯é€»è¾‘ -->
    <script src="js/auth.js"></script>
    
    <!-- èˆªç¨‹å¼•å¯¼æ¨¡å— - 3Då¤ªé˜³ç³»åœºæ™¯åŠ¨ç”»ï¼ˆæ¨¡å—åŒ–ç‰ˆæœ¬ï¼‰ -->
    <script src="js/voyage-core.js"></script>
    <script src="js/voyage-planets.js"></script>
    <script src="js/voyage-earth.js"></script>
    <script src="js/voyage-animation.js"></script>
    <script src="js/voyage-main.js"></script>
    
    <!-- ä¸»åº”ç”¨åˆå§‹åŒ–è„šæœ¬ -->
    <script>
        /**
         * MOSS æ¡£æ¡ˆé¦†ä¸»åº”ç”¨
         * è´Ÿè´£åè°ƒå„ä¸ªæ¨¡å—çš„åˆå§‹åŒ–å’Œäº¤äº’
         */
        
        // åº”ç”¨çŠ¶æ€ç®¡ç†
        const AppState = {
            currentModule: 'auth',          // å½“å‰æ´»è·ƒæ¨¡å—
            isInitialized: false,           // åˆå§‹åŒ–çŠ¶æ€
            modules: {}                     // æ¨¡å—æ³¨å†Œè¡¨
        };
        
        /**
         * åº”ç”¨åˆå§‹åŒ–å‡½æ•°
         * åœ¨é¡µé¢åŠ è½½å®Œæˆåæ‰§è¡Œ
         */
        function initializeApp() {
            console.log('ğŸš€ æ­£åœ¨å¯åŠ¨ MOSS çºªå¿µæ¡£æ¡ˆé¦†ç³»ç»Ÿ...');
            
            try {
                // åˆå§‹åŒ–è®¤è¯æ¨¡å—
                if (window.AuthModule) {
                    window.AuthModule.init();
                    window.AuthModule.show(); // æ˜¾ç¤ºè®¤è¯æ¨¡å—
                    AppState.modules.auth = window.AuthModule;
                    console.log('âœ… è®¤è¯æ¨¡å—åˆå§‹åŒ–å®Œæˆ');
                }
                
                // é¢„åˆå§‹åŒ–èˆªç¨‹å¼•å¯¼æ¨¡å—ï¼ˆæ¨¡å—åŒ–ç‰ˆæœ¬ï¼‰
                if (window.VoyageMain && window.initVoyage) {
                    // åˆ›å»ºå…¼å®¹å±‚ï¼Œé€‚é…åŸæœ‰çš„VoyageModuleæ¥å£
                    window.VoyageModule = {
                        init: () => {
                            console.log('âœ… èˆªç¨‹å¼•å¯¼æ¨¡å—é¢„åŠ è½½å®Œæˆ');
                            return true;
                        },
                        show: async () => {
                            console.log('ğŸš€ å¯åŠ¨èˆªç¨‹å¼•å¯¼æ¨¡å—...');
                            const voyageContainer = document.getElementById('voyageContainer');
                            if (voyageContainer) {
                                voyageContainer.style.display = 'block';
                                
                                // æ£€æŸ¥å¿…è¦çš„ä¾èµ–
                                if (typeof THREE === 'undefined') {
                                    throw new Error('Three.js åº“æœªåŠ è½½');
                                }
                                
                                if (typeof THREE.OrbitControls === 'undefined') {
                                    throw new Error('OrbitControls æœªåŠ è½½');
                                }
                                
                                // æ£€æŸ¥æ¨¡å—æ˜¯å¦åŠ è½½
                                const requiredModules = [
                                    'createScene',
                                    'createSolarSystem', 
                                    'createEarth',
                                    'TimelineManager',
                                    'VoyageMain'
                                ];
                                
                                for (const moduleName of requiredModules) {
                                    if (typeof window[moduleName] === 'undefined') {
                                        console.error(`æ¨¡å— ${moduleName} æœªåŠ è½½`);
                                        throw new Error(`æ¨¡å— ${moduleName} æœªåŠ è½½`);
                                    }
                                }
                                
                                const voyage = await window.initVoyage('voyageContainer');
                                if (voyage) {
                                    voyage.play();
                                    window.voyageInstance = voyage;
                                    console.log('âœ… èˆªç¨‹å¼•å¯¼æ¨¡å—å¯åŠ¨æˆåŠŸ');
                                } else {
                                    throw new Error('èˆªç¨‹å¼•å¯¼æ¨¡å—åˆå§‹åŒ–å¤±è´¥');
                                }
                            }
                        },
                        hide: () => {
                            const voyageContainer = document.getElementById('voyageContainer');
                            if (voyageContainer) {
                                voyageContainer.style.display = 'none';
                            }
                            if (window.voyageInstance) {
                                window.voyageInstance.pause();
                            }
                        },
                        skipAnimation: () => {
                            if (window.voyageInstance) {
                                window.voyageInstance.reset();
                            }
                        },
                        isActive: () => {
                            return window.voyageInstance && window.voyageInstance.timelineManager && window.voyageInstance.timelineManager.isPlaying;
                        }
                    };
                    
                    window.VoyageModule.init();
                    AppState.modules.voyage = window.VoyageModule;
                    console.log('âœ… èˆªç¨‹å¼•å¯¼æ¨¡å—é¢„åŠ è½½å®Œæˆ');
                }
                
                // æ ‡è®°åº”ç”¨å·²åˆå§‹åŒ–
                AppState.isInitialized = true;
                
                // è®¾ç½®å…¨å±€é”™è¯¯å¤„ç†
                setupGlobalErrorHandling();
                
                console.log('ğŸ‰ MOSS ç³»ç»Ÿå¯åŠ¨å®Œæˆï¼');
                console.log('ğŸ’¡ è¯·è¾“å…¥ "login" å¼€å§‹ä½“éªŒ');
                
            } catch (error) {
                console.error('âŒ ç³»ç»Ÿåˆå§‹åŒ–å¤±è´¥:', error);
                showSystemError('ç³»ç»Ÿåˆå§‹åŒ–å¤±è´¥ï¼Œè¯·åˆ·æ–°é¡µé¢é‡è¯•');
            }
        }
        
        /**
         * è®¾ç½®å…¨å±€é”™è¯¯å¤„ç†
         */
        function setupGlobalErrorHandling() {
            // æ•è·æœªå¤„ç†çš„ JavaScript é”™è¯¯
            window.addEventListener('error', function(event) {
                console.error('ğŸš¨ ç³»ç»Ÿé”™è¯¯:', event.error);
                // åœ¨ç”Ÿäº§ç¯å¢ƒä¸­ï¼Œè¿™é‡Œå¯ä»¥å‘é€é”™è¯¯æŠ¥å‘Š
            });
            
            // æ•è·æœªå¤„ç†çš„ Promise æ‹’ç»
            window.addEventListener('unhandledrejection', function(event) {
                console.error('ğŸš¨ æœªå¤„ç†çš„ Promise é”™è¯¯:', event.reason);
                event.preventDefault();
            });
        }
        
        /**
         * æ˜¾ç¤ºç³»ç»Ÿé”™è¯¯ä¿¡æ¯
         * @param {string} message - é”™è¯¯æ¶ˆæ¯
         */
        function showSystemError(message) {
            const errorDiv = document.createElement('div');
            errorDiv.style.cssText = `
                position: fixed;
                top: 50%;
                left: 50%;
                transform: translate(-50%, -50%);
                background: rgba(255, 65, 54, 0.1);
                border: 1px solid #FF4136;
                color: #FF4136;
                padding: 20px;
                border-radius: 5px;
                font-family: 'Roboto Mono', monospace;
                text-align: center;
                z-index: 9999;
            `;
            errorDiv.innerHTML = `
                <h3>âš ï¸ ç³»ç»Ÿé”™è¯¯</h3>
                <p>${message}</p>
            `;
            document.body.appendChild(errorDiv);
        }
        
        /**
         * æ¨¡å—åˆ‡æ¢å‡½æ•°
         * @param {string} fromModule - æºæ¨¡å—åç§°
         * @param {string} toModule - ç›®æ ‡æ¨¡å—åç§°
         */
        function switchModule(fromModule, toModule) {
            console.log(`ğŸ”„ æ¨¡å—åˆ‡æ¢: ${fromModule} -> ${toModule}`);
            
            // éšè—å½“å‰æ¨¡å—
            if (AppState.modules[fromModule] && AppState.modules[fromModule].hide) {
                AppState.modules[fromModule].hide();
            }
            
            // æ˜¾ç¤ºç›®æ ‡æ¨¡å—
            if (AppState.modules[toModule] && AppState.modules[toModule].show) {
                AppState.modules[toModule].show();
                AppState.currentModule = toModule;
            }
        }
        
        // é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–åº”ç”¨
        window.addEventListener('load', initializeApp);
        
        // å¯¼å‡ºå…¨å±€åº”ç”¨æ¥å£
        window.MossApp = {
            state: AppState,
            switchModule: switchModule,
            showError: showSystemError
        };
        
        // å¼€å‘æ¨¡å¼ä¸‹çš„è°ƒè¯•å·¥å…·
        if (window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1') {
            console.log('ğŸ”§ å¼€å‘æ¨¡å¼å·²å¯ç”¨');
            
            // æä¾›è°ƒè¯•å¿«æ·æ–¹å¼
            window.debug = {
                resetAuth: () => AppState.modules.auth?.reset(),
                switchToConsole: () => switchModule('auth', 'console'),
                getState: () => AppState
            };
        }
    </script>
</body>
</html>